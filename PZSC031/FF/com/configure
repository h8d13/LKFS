#!/usr/bin/env python3
"""
Kernel Configuration Module
Handles kernel configuration without GUI menuconfig
"""

import subprocess
import shutil
from pathlib import Path


class KernelConfigurator:
    def __init__(self, kernel_dir, quiet=False):
        self.kernel_dir = Path(kernel_dir)
        self.config_file = self.kernel_dir / ".config"
        self.quiet = quiet

    def use_default_config(self):
        """Use default kernel configuration"""
        print("Generating default kernel config")
        stdout_arg = subprocess.DEVNULL if self.quiet else None
        try:
            subprocess.run(
                ["make", "defconfig"],
                cwd=self.kernel_dir,
                check=True,
                stdout=stdout_arg
            )
            print("Default config generated")
            return True
        except subprocess.CalledProcessError as e:
            raise Exception(f"Failed to generate default config: {e}")

    def use_current_config(self):
        """Use currently running kernel's config"""
        current_config = Path("/boot/config-$(uname -r)")
        proc_config = Path("/proc/config.gz")

        config_source = None
        if current_config.exists():
            config_source = current_config
        elif proc_config.exists():
            print("Extracting config from /proc/config.gz")
            try:
                subprocess.run(
                    f"zcat /proc/config.gz > {self.config_file}",
                    shell=True,
                    check=True
                )
                return True
            except subprocess.CalledProcessError as e:
                raise Exception(f"Failed to extract config: {e}")

        if config_source:
            print(f"Copying config from {config_source}")
            shutil.copy(config_source, self.config_file)
            stdout_arg = subprocess.DEVNULL if self.quiet else None
            subprocess.run(
                ["make", "olddefconfig"],
                cwd=self.kernel_dir,
                check=True,
                stdout=stdout_arg
            )
            print("Current kernel config applied")
            return True

        raise Exception("Could not find current kernel config")

    def use_custom_config(self, config_path):
        """Use a custom full .config file"""
        custom = Path(config_path)
        if not custom.exists():
            raise Exception(f"Config file not found: {config_path}")

        print(f"Using config from {config_path}")
        shutil.copy(custom, self.config_file)

        # Update for new kernel version
        stdout_arg = subprocess.DEVNULL if self.quiet else None
        subprocess.run(
            ["make", "olddefconfig"],
            cwd=self.kernel_dir,
            check=True,
            stdout=stdout_arg
        )
        print("Config applied and updated for kernel version")
        return True

    def use_fragment_config(self, fragment_path):
        """Use a config fragment on top of defconfig"""
        fragment = Path(fragment_path)
        if not fragment.exists():
            raise Exception(f"Config fragment not found: {fragment_path}")

        print(f"Applying config fragment from {fragment_path}")

        # Start with defconfig
        stdout_arg = subprocess.DEVNULL if self.quiet else None
        subprocess.run(
            ["make", "defconfig"],
            cwd=self.kernel_dir,
            check=True,
            stdout=stdout_arg
        )

        # Append fragment
        with open(fragment, 'r') as f:
            fragment_lines = f.readlines()

        with open(self.config_file, 'a') as f:
            f.write("\n# Custom fragment additions\n")
            f.writelines(fragment_lines)

        # Resolve dependencies
        subprocess.run(
            ["make", "olddefconfig"],
            cwd=self.kernel_dir,
            check=True,
            stdout=stdout_arg
        )
        print("Fragment applied to defconfig")
        return True

    def set_config_option(self, option, value):
        """Set a specific kernel config option using scripts/config"""
        config_script = self.kernel_dir / "scripts" / "config"
        if not config_script.exists():
            raise Exception("Kernel config script not found")

        if value is True or value == "y":
            flag = "--enable"
        elif value is False or value == "n":
            flag = "--disable"
        elif value == "m":
            flag = "--module"
        else:
            flag = "--set-str"

        try:
            subprocess.run(
                [str(config_script), flag, option],
                cwd=self.kernel_dir,
                check=True
            )
            print(f"Set {option} = {value}")
            return True
        except subprocess.CalledProcessError as e:
            raise Exception(f"Failed to set config option: {e}")
